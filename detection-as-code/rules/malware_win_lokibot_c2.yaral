rule malware_win_lokibot_c2 {
  
  meta:
    author = "Google Cloud Security"
    description = "Identify default Lokibot C2 Traffic"
    type = "alert"
    data_source = "zscalar"
    severity = "Critical"
    priority = "Critical"

  events:
    $network.metadata.base_labels.namespaces = "LogStory"
    $network.metadata.base_labels.namespaces = "LogStory"
    $network.metadata.event_type = "NETWORK_HTTP"
    $network.target.ip = $ip
    $network.target.url = /.*\/fre\.php/ nocase

  match:
    $ip over 5m

  outcome:
    $risk_score = max(95)
    $event_count = count_distinct($network.metadata.id)
    //added to populate alert graph with additional context
    $principal_hostname = array_distinct($network.principal.hostname)
    $target_hostname = array_distinct($network.target.hostname)
    $principal_user_userid = array_distinct($network.principal.user.userid)
    $target_url = array_distinct($network.target.url)
   
  condition:
    $network

}
