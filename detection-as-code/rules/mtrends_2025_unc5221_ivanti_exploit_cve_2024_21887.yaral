rule mtrends_2025_unc5221_ivanti_exploit_cve_2024_21887 {
  meta:
    author = "Google Cloud Security"
    description = "Detects exploitation attempts of Ivanti Connect Secure VPN vulnerabilities CVE-2023-46805 and CVE-2024-21887, associated with threat actor UNC5221 as mentioned in M-Trends 2025."
    rule_id = "mr_b1a2c3d4-e5f6-7890-1234-567890abcdef"
    rule_name = "M-Trends 2025 UNC5221 Ivanti Exploit"
    mitre_attack_tactic = "TA0001"
    mitre_attack_technique = "T1190"
    type = "alert"
    data_source = "network http logs"
    severity = "Critical"
    priority = "Critical"
    reference = "https://services.google.com/fh/files/misc/m-trends-2025-en.pdf"

  events:
    $http.metadata.event_type = "NETWORK_HTTP"
    $http.principal.ip = $principal_ip
    $http.target.hostname = $target_hostname
    // Using the field identified by the last error
    re.regex($http.network.http.referral_url, `.*/api/v1/totp/user-backup-code/\\.\\./\\.\\./(system/maintenance/archiving/cloud-server-test-connection|license/keys-status)`)

  match:
    $principal_ip, $target_hostname over 10m

  outcome:
    $risk_score = 100
    // CONFLICTING LINES REMOVED: $principal_ip and $target_hostname are already available.
    $principal_hostnames = array_distinct($http.principal.hostname)
    $target_ports = array_distinct($http.target.port)
    $urls = array_distinct($http.network.http.referral_url)
    $user_agents = array_distinct($http.network.http.user_agent)
    $event_count = count($http.metadata.id)

  condition:
    $http
}
